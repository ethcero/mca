config:
    plugins:
        expect: {}
    target: 'https://localhost:8443/api'
    http:
        pool: 8
    phases:
        - duration: 40
          arrivalRate: 5
    ensure:
        p95: 100
        maxErrorRate: 0
    payload:
        - path: "./tweets.csv"
          fields:
            - "content"
            - "image_link"
        - path: "./users.csv"
          fields:
            - "userId"
            - "username"
            - "password"
scenarios:
    - name: Consulta del primer Tweet
      weight: 5
      flow:
        - get:
            url: "/tweets/"
            capture:
                json: "$[0].id"
                as: "id"
        - get:
            url: "/tweets/{{ id }}"
            expect:
                - statusCode: 200

    - name: Crear un nuevo tweet
      weight: 2
      flow:
        - get:
            url: "/logIn"
            auth:
                user: "{{ username }}"
                pass: "{{ password }}"
            expect:
                - statusCode: 200
        - post:
            url: "/tweets/"
            auth:
                user: "{{ username }}"
                pass: "{{ password }}"
            json:
                content: "{{ content }}"
                image_link: "{{ image_link }}"
            expect:
                - statusCode: 201
            capture:
                json: "$.id"
                as: "id"
        - get:
            url: "/tweets/{{ id }}"
            expect:
                - statusCode: 200
  
    - name: Borrado de un tweet propio
      weight: 1
      flow:
        - get:
            url: "/logIn"
            auth:
                user: "{{ username }}"
                pass: "{{ password }}"
            expect:
                - statusCode: 200
        - get:
            url: "/users/{{ userId }}"
            auth:
                user: "{{ username }}"
                pass: "{{ password }}"            
            expect:
                - statusCode: 200
            capture:
                json: "$.tweets[0].id"
                as: "id"
        - delete:
            url: "/tweets/{{ id }}"
            ifTrue: "{{ id }} not undefined"
            expect:
                - statusCode: 200
        - get:
            url: "/tweets/{{ id }}"
            ifTrue: "{{ id }} not undefined"
            expect: 404